<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AnimeFinds — Find Your Next Favorite Anime — Fast AF</title>
  <meta name="description" content="Discover new anime with AnimeFinds. Get smart recommendations by title or filter by genre, year, length, and mood." />
  <style>/* styles unchanged from current */</style>
</head>
<body>
  <!-- header, hero, and input UI unchanged from current -->

  <script>
    // Tabs behavior
    const tabTitle = document.getElementById('tab-title');
    const tabFilters = document.getElementById('tab-filters');
    const panelTitle = document.getElementById('panel-title');
    const panelFilters = document.getElementById('panel-filters');

    function activate(tab){
      const isTitle = tab === 'title';
      tabTitle.classList.toggle('active', isTitle);
      tabTitle.setAttribute('aria-selected', isTitle);
      panelTitle.hidden = !isTitle;
      tabFilters.classList.toggle('active', !isTitle);
      tabFilters.setAttribute('aria-selected', !isTitle);
      panelFilters.hidden = isTitle;
    }
    tabTitle.addEventListener('click', () => activate('title'));
    tabFilters.addEventListener('click', () => activate('filters'));

    // Elements
    const likeInput = document.getElementById('like-input');
    const titleHints = document.getElementById('title-hints');
    const byTitleBtn = document.getElementById('byTitleBtn');
    const byFiltersBtn = document.getElementById('byFiltersBtn');
    const results = document.getElementById('results');
    const emptyState = document.getElementById('empty-state');
    const emptyText = document.getElementById('empty-text');
    const loader = document.getElementById('loader');
    const resultCount = document.getElementById('result-count');

    // -------- AniList GraphQL helpers --------
    const ANILIST_ENDPOINT = 'https://graphql.anilist.co';

    async function gql(query, variables={}){
      const res = await fetch(ANILIST_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ query, variables })
      });
      if(!res.ok){ throw new Error(`AniList error ${res.status}`); }
      const json = await res.json();
      if(json.errors){ throw new Error(json.errors.map(e=>e.message).join(', ')); }
      return json.data;
    }

    function pickTitle(t){
      return t?.english || t?.romaji || t?.native || 'Untitled';
    }

    function toCard(media){
      return {
        title: pickTitle(media.title),
        genre: (media.genres && media.genres[0]) || '',
        image: media.coverImage?.large || media.coverImage?.medium || '',
        meta: [
          media.genres?.slice(0,2).join(' / '),
          media.episodes ? `${media.episodes} eps` : null,
          media.seasonYear || null
        ].filter(Boolean).join(' • ')
      };
    }

    // Render cards
    function renderResults(items){
      results.innerHTML = '';
      if(!items || !items.length){
        results.appendChild(emptyState);
        emptyState.style.display = 'grid';
        loader.style.display = 'none';
        emptyText.textContent = 'No matches yet. Try another title or widen your filters.';
        resultCount.textContent = '';
        return;
      }
      resultCount.textContent = `${items.length} result${items.length>1?'s':''}`;
      items.forEach(item => {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="thumb">
            <img src="${item.image}" alt="${item.title} poster" />
            <span class="badge">${item.genre || ''}</span>
          </div>
          <div class="content">
            <h3 class="title">${item.title}</h3>
            <div class="meta">${item.meta || ''}</div>
          </div>`;
        results.appendChild(card);
      });
    }

    function startLoading(text){
      emptyState.style.display='grid';
      loader.style.display='block';
      emptyText.textContent=text;
      results.innerHTML = '';
      results.appendChild(emptyState);
    }

    // -------- Title → Similar recommendations --------
    const QUERY_SIMILAR = `
      query ($search: String) {
        Media(search: $search, type: ANIME) {
          id
          title { romaji english native }
          coverImage { large medium }
          genres
          episodes
          seasonYear
          recommendations(perPage: 24) {
            nodes {
              mediaRecommendation {
                id
                title { romaji english native }
                coverImage { large medium }
                genres
                episodes
                seasonYear
              }
            }
          }
        }
      }
    `;

    async function fetchSimilarByTitle(title){
      const data = await gql(QUERY_SIMILAR, { search: title });
      const base = data?.Media;
      if(!base){ return []; }
      const recNodes = base.recommendations?.nodes || [];
      const media = recNodes.map(n => n.mediaRecommendation).filter(Boolean);
      return media.map(toCard);
    }

    // -------- Filtered search --------
    const QUERY_FILTERS = `
      query ($genre: String, $year: Int, $epMin: Int, $epMax: Int, $tags: [String]) {
        Page(perPage: 24) {
          media(type: ANIME, sort: POPULARITY_DESC,
                genre_in: [$genre], seasonYear: $year,
                episodes_greater: $epMin, episodes_lesser: $epMax,
                tag_in: $tags) {
            id
            title { romaji english native }
            coverImage { large medium }
            genres
            episodes
            seasonYear
          }
        }
      }
    `;

    const MOOD_TAGS = {
      cozy: ['Iyashikei','Cute Girls Doing Cute Things','CGDCT','Slice of Life'],
      hype: ['Battle Shounen','Shounen','Super Power','Sports'],
      feels: ['Tragedy','Tearjerker','Coming of Age','Family Life'],
      dark: ['Psychological','Horror','Gore','Death']
    };

    function mapLengthToBounds(len){
      if(len === 'short') return { epMin: 0, epMax: 12 };
      if(len === 'standard') return { epMin: 12, epMax: 26 };
      if(len === 'long') return { epMin: 26, epMax: 999 };
      return { epMin: null, epMax: null };
    }

    async function fetchByFilters(filters){
      const { epMin, epMax } = mapLengthToBounds(filters.length);
      const tags = filters.mood ? MOOD_TAGS[filters.mood] : null;
      const yearInt = /^\d{4}$/.test(filters.year) ? parseInt(filters.year,10) : null;
      const data = await gql(QUERY_FILTERS, {
        genre: filters.genre || null,
        year: yearInt,
        epMin: epMin,
        epMax: epMax,
        tags: tags
      });
      const media = data?.Page?.media || [];
      return media.map(toCard);
    }

    // -------- Wire up actions --------
    byTitleBtn.addEventListener('click', async () => {
      const like = (likeInput.value || '').trim();
      if(!like){ likeInput.focus(); return; }
      try{
        startLoading('Finding similar titles…');
        const items = await fetchSimilarByTitle(like);
        renderResults(items);
      }catch(err){
        console.error(err);
        emptyText.textContent = 'Whoops, something went wrong fetching recommendations.';
        loader.style.display='none';
      }
    });

    byFiltersBtn.addEventListener('click', async () => {
      const filters = {
        genre: document.getElementById('genre').value,
        length: document.getElementById('length').value,
        year: document.getElementById('year').value,
        mood: document.getElementById('mood').value,
      };
      try{
        startLoading('Applying filters…');
        const items = await fetchByFilters(filters);
        renderResults(items);
      }catch(err){
        console.error(err);
        emptyText.textContent = 'Could not load filtered results. Try adjusting filters.';
        loader.style.display='none';
      }
    });

    // -------- Typeahead suggestions (AniList) --------
    const QUERY_HINTS = `
      query ($search: String) {
        Page(perPage: 5) {
          media(type: ANIME, search: $search, sort: POPULARITY_DESC) {
            title { romaji english native }
          }
        }
      }
    `;

    let hintTimer;
    likeInput.addEventListener('input', () => {
      clearTimeout(hintTimer);
      const q = likeInput.value.trim();
      if(!q){ titleHints.textContent=''; return; }
      hintTimer = setTimeout(async () => {
        try{
          const data = await gql(QUERY_HINTS, { search: q });
          const titles = (data?.Page?.media || []).map(m => pickTitle(m.title));
          titleHints.textContent = titles.length ? 'Suggestions: ' + titles.join(' • ') : '';
        }catch{ /* ignore */ }
      }, 250);
    });
  </script>
</body>
</html>
